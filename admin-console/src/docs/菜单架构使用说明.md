# 管理端菜单架构使用说明

## 概述

叨叨房车管理端菜单架构已完成设计实现，支持基于角色的动态菜单生成和权限控制。本文档详细说明菜单架构的使用方法和扩展指南。

## 菜单架构特性

### ✅ 已实现功能

1. **四大功能模块支持**
   - 核心业务管理（7个子模块）
   - 营销运营管理（4个子模块）
   - 系统管理（3个子模块）
   - 数据分析（2个子模块）

2. **四层角色权限体系**
   - 平台管理员：全部权限
   - 区域经理：区域级权限
   - 门店经理：门店级权限
   - 门店员工：基础操作权限

3. **动态路由生成**
   - 基于菜单配置自动生成路由
   - 权限过滤和访问控制
   - 面包屑导航支持

4. **响应式侧边栏**
   - 支持折叠/展开
   - 图标和文字显示
   - 层级嵌套支持

## 目录结构

```
src/
├── types/
│   └── menu.ts                    # 菜单相关类型定义
├── config/
│   └── menu.ts                    # 菜单配置数据
├── utils/
│   ├── route.ts                   # 路由生成工具
│   └── permission.ts              # 权限工具类
├── composables/
│   └── useAuth.ts                 # 认证状态管理
├── directives/
│   └── permission.ts              # 权限指令
├── layout/
│   ├── index.vue                  # 主布局组件
│   └── components/
│       ├── SidebarMenuItem.vue    # 侧边栏菜单项
│       └── Breadcrumb.vue         # 面包屑导航
├── views/
│   └── dashboard/
│       └── Overview.vue           # 工作台示例页面
└── router/
    └── index.ts                   # 路由配置（已更新）
```

## 使用方法

### 1. 权限检查

#### 在模板中使用权限指令
```vue
<template>
  <!-- 基础权限检查 -->
  <el-button v-permission="'user:create'">创建用户</el-button>

  <!-- 多个权限检查（任意一个） -->
  <el-button v-permission="['user:edit', 'user:delete']">操作</el-button>

  <!-- 角色检查 -->
  <div v-role="'admin'">管理员可见</div>

  <!-- 数据权限检查 -->
  <el-table v-data-scope="'all'">全部数据</el-table>

  <!-- 复杂权限配置 -->
  <el-button
    v-permission="{
      permission: 'user:delete',
      mode: 'all'
    }">
    删除用户
  </el-button>
</template>
```

#### 在脚本中使用权限钩子
```vue
<script setup lang="ts">
import { useAuth } from '@/composables/useAuth'
import { PermissionUtils } from '@/utils/permission'

const { hasPermission, hasRole, user } = useAuth()

// 权限检查
const canCreateUser = hasPermission('user:create')
const isAdmin = hasRole('platform_admin')

// 使用工具类
const hasUserPermission = PermissionUtils.checkPermission('user:list', user.permissions)

// 权限检查并提示
function deleteUser() {
  if (PermissionUtils.checkAndShowPermission('user:delete', user.permissions, '删除用户')) {
    // 执行删除操作
  }
}
</script>
```

### 2. 菜单配置

#### 添加新菜单项
编辑 `src/config/menu.ts`：

```typescript
// 在对应模块中添加新菜单
{
  id: 'new-feature',
  name: 'NewFeature',
  title: '新功能',
  icon: 'Star',
  type: 'menu',
  sort: 8,
  children: [
    {
      id: 'new-feature-list',
      name: 'NewFeatureList',
      title: '功能列表',
      path: '/new-feature/list',
      component: '@/views/new-feature/List.vue',
      type: 'page',
      sort: 1,
      permission: ['new-feature:list']
    }
  ]
}
```

#### 修改菜单权限
```typescript
{
  id: 'sensitive-feature',
  // ...其他配置
  permission: ['admin:sensitive'], // 添加权限要求
}
```

### 3. 创建新页面

#### 1. 创建页面组件
在 `src/views/` 下创建对应页面：

```vue
<template>
  <div class="new-feature-page">
    <el-page-header @back="goBack" title="新功能">
      <template #content>
        <span class="text-large font-600 mr-3"> 功能列表 </span>
      </template>
    </el-page-header>

    <el-card class="mt-4">
      <!-- 页面内容 -->
      <el-button v-permission="'new-feature:create'" type="primary">
        创建
      </el-button>

      <el-table :data="tableData">
        <el-table-column prop="name" label="名称" />
        <el-table-column label="操作">
          <template #default="{ row }">
            <el-button
              v-permission="'new-feature:edit'"
              size="small"
              @click="editRow(row)"
            >
              编辑
            </el-button>
          </template>
        </el-table-column>
      </el-table>
    </el-card>
  </div>
</template>

<script setup lang="ts">
import { useRouter } from 'vue-router'
import { ref } from 'vue'

const router = useRouter()
const tableData = ref([])

const goBack = () => {
  router.back()
}

const editRow = (row: any) => {
  console.log('编辑:', row)
}
</script>
```

#### 2. 菜单会自动生成
路由系统会根据菜单配置自动生成路由，无需手动配置。

### 4. 角色权限配置

#### 修改角色权限
编辑 `src/composables/useAuth.ts` 中的 `mockLoginApi` 函数：

```typescript
const mockUsers: Record<string, UserInfo> = {
  // 添加新角色用户
  'new_role': {
    id: '5',
    username: 'new_role',
    name: '新角色',
    role: RoleCode.STORE_MANAGER,
    roleName: '门店经理',
    permissions: [
      'user:list',
      'vehicle:list',
      // ... 其他权限
    ]
  }
}
```

#### 自定义权限映射
在 `src/utils/permission.ts` 中的 `getActionPermissions` 方法：

```typescript
static getActionPermissions(userRole: RoleCode): string[] {
  const permissionMap: Record<RoleCode, string[]> = {
    [RoleCode.PLATFORM_ADMIN]: ['*'],
    [RoleCode.REGION_MANAGER]: [
      // 区域经理权限配置
    ],
    // ...其他角色
  }
  return permissionMap[userRole] || []
}
```

## 开发指南

### 1. 添加新的权限类型

#### 扩展角色枚举
编辑 `src/types/menu.ts`：

```typescript
export enum RoleCode {
  PLATFORM_ADMIN = 'platform_admin',
  REGION_MANAGER = 'region_manager',
  STORE_MANAGER = 'store_manager',
  STORE_EMPLOYEE = 'store_employee',
  // 添加新角色
  FINANCE_ADMIN = 'finance_admin',
}
```

#### 更新权限工具类
编辑 `src/utils/permission.ts`：

```typescript
export class PermissionUtils {
  static getDataScopeByRole(role: RoleCode): string[] {
    const dataScopeMap: Record<RoleCode, string[]> = {
      // ...现有配置
      [RoleCode.FINANCE_ADMIN]: ['all', 'region'], // 财务管理员权限
    }
    return dataScopeMap[role] || ['self']
  }
}
```

### 2. 自定义权限检查

#### 创建权限检查函数
```typescript
// utils/customPermission.ts
import { useAuth } from '@/composables/useAuth'

export function useCustomPermission() {
  const { user } = useAuth()

  // 检查是否可以操作指定门店
  const canOperateStore = (storeId: string): boolean => {
    if (!user.value) return false

    // 管理员可以操作所有门店
    if (user.value.role === RoleCode.PLATFORM_ADMIN) return true

    // 区域经理检查区域权限
    if (user.value.role === RoleCode.REGION_MANAGER) {
      return // 检查门店是否在管辖区域内
    }

    // 门店经理只能操作自己的门店
    if (user.value.role === RoleCode.STORE_MANAGER) {
      return user.value.storeId === storeId
    }

    return false
  }

  return { canOperateStore }
}
```

### 3. 菜单样式定制

#### 修改侧边栏样式
编辑 `src/layout/index.vue` 中的样式：

```scss
.sidebar {
  // 自定义背景色
  background-color: #1a1a1a;

  .sidebar-menu {
    // 菜单项样式
    :deep(.el-menu-item) {
      &.is-active {
        background-color: #1890ff !important;
      }
    }
  }
}
```

## 测试账号

为了方便测试，系统提供以下测试账号（在 `useAuth.ts` 中配置）：

| 用户名 | 密码 | 角色 | 权限范围 |
|--------|------|------|----------|
| admin | 123456 | 平台管理员 | 全部数据和功能 |
| manager | 123456 | 区域经理 | 所辖区域数据 |
| store | 123456 | 门店经理 | 本门店数据 |
| employee | 123456 | 门店员工 | 分配的任务数据 |

## API集成指南

### 替换模拟API

当后端API准备好时，需要替换以下模拟API：

#### 1. 登录API
编辑 `src/composables/useAuth.ts` 中的 `login` 方法：

```typescript
const login = async (credentials: LoginCredentials) => {
  try {
    // 替换为真实API调用
    const response = await authApi.login(credentials)

    if (response.data.token) {
      // 处理登录成功逻辑
      return true
    }
  } catch (error) {
    // 处理登录失败
    return false
  }
}
```

#### 2. 用户信息API
```typescript
const refreshUserInfo = async () => {
  try {
    const response = await userApi.getCurrentUserInfo()
    // 更新用户信息
  } catch (error) {
    // 处理错误
  }
}
```

#### 3. 菜单API（可选）
如果需要从后端动态获取菜单：

```typescript
// src/api/menu.ts
export const menuApi = {
  getUserMenus: () => request.get('/api/menus/user'),
  checkPermission: (permission: string) => request.post('/api/permissions/check', { permission })
}
```

## 最佳实践

### 1. 权限设计原则

- **最小权限原则**：用户只获得完成任务所需的最小权限
- **职责分离**：不同角色承担不同职责，避免权限重叠
- **数据权限**：基于角色的数据访问范围控制

### 2. 组件权限控制

```vue
<template>
  <!-- 推荐：使用指令控制 -->
  <el-button v-permission="'user:create'">创建用户</el-button>

  <!-- 可选：使用v-if控制 -->
  <el-button v-if="hasPermission('user:create')">创建用户</el-button>
</template>
```

### 3. API权限验证

```typescript
// 在API调用前检查权限
function deleteUser(userId: string) {
  if (!hasPermission('user:delete')) {
    ElMessage.error('无权限删除用户')
    return
  }

  // 调用删除API
  await userApi.delete(userId)
}
```

### 4. 路由权限守卫

路由权限守卫已在 `src/router/index.ts` 中实现，确保未授权用户无法访问受保护页面。

## 故障排除

### 常见问题

1. **菜单不显示**
   - 检查用户权限配置
   - 确认菜单ID是否正确
   - 查看浏览器控制台错误信息

2. **权限检查失效**
   - 确认用户信息是否正确加载
   - 检查权限字符串格式
   - 验证角色权限映射

3. **路由跳转失败**
   - 检查路由配置是否正确
   - 确认组件文件路径是否存在
   - 验证权限配置

### 调试技巧

1. **查看当前用户权限**
```javascript
// 在浏览器控制台执行
console.log('用户信息:', JSON.parse(localStorage.getItem('userInfo')))
console.log('用户权限:', JSON.parse(localStorage.getItem('userInfo')).permissions)
```

2. **检查菜单生成**
```javascript
// 在布局组件中添加调试信息
console.log('用户菜单:', menuList.value)
```

3. **权限检查日志**
在权限检查函数中添加日志输出，跟踪权限验证过程。

## 后续扩展

菜单架构已支持以下扩展：

1. **多级菜单嵌套**：支持无限层级菜单
2. **权限动态更新**：支持运行时权限变更
3. **主题定制**：支持自定义主题色彩
4. **国际化**：预留多语言支持接口
5. **菜单搜索**：可扩展菜单搜索功能
6. **个性化配置**：可保存用户菜单偏好

## 技术栈

- **Vue 3**：响应式框架
- **Vue Router 4**：路由管理
- **Element Plus**：UI组件库
- **TypeScript**：类型安全
- **Pinia**：状态管理（已集成）
- **SCSS**：样式预处理

---

## 总结

叨叨管理端菜单架构已完成设计实现，具备以下核心能力：

1. ✅ **完整的四层权限体系**
2. ✅ **动态菜单生成和路由**
3. ✅ **响应式侧边栏布局**
4. ✅ **权限指令和工具函数**
5. ✅ **角色化数据权限控制**
6. ✅ **可扩展的架构设计**

系统已准备好进行具体功能模块的开发，所有业务模块都可以基于这套菜单架构快速搭建。